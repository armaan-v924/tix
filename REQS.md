# Project Requirements: tix (Worktree Manager)

**Project Name:** `tix`
**Goal:** A CLI tool to manage git worktrees across multiple repositories, organized by "ticket" (task/context). It allows developers to maintain a clean context for every Jira ticket or task without disrupting their main development branches.

---

## 1. Technical Stack & Architecture
* **Language:** Rust (2021 edition)
* **CLI Parsing:** `clap` (derive feature)
* **Git Operations:** `git2` (libgit2 bindings) for robust, typed git handling (no shelling out to binaries).
* **Configuration:** `toml` serialization via `serde`.
* **Logging:** `env_logger` with `log` crate (supports `--quiet`, `--verbose`).
* **Platform:** Cross-platform path handling (via `directories` and `home` crates).

---

## 2. Core Concepts & Data Structures

### A. Directory Structure
* **Code Directory:** Where the "source" repositories (bare or regular) live (e.g., `~/code/`).
* **Tickets Directory:** Where worktrees are created (e.g., `~/tickets/`).
* **Ticket Workspace:** A folder named after the ticket ID (e.g., `~/tickets/JIRA-123/`) containing:
    * `.tix/info.toml`: Metadata file (ID, Description, Timestamp).
    * `backend/`: A git worktree of the backend repo.
    * `frontend/`: A git worktree of the frontend repo.

### B. Configuration (`config.toml`)
Located in standard OS config path (e.g., `~/.config/tix/config.toml`).

| Field | Type | Description |
| :--- | :--- | :--- |
| `tickets_directory` | Path | Root folder for ticket workspaces. |
| `code_directory` | Path | Root folder for source repositories. |
| `default_repository_owner` | String | Default Github org/user (e.g., "my-org"). |
| `github_base_url` | String | Base git URL (e.g., "git@github.com"). |
| `branch_prefix` | String | Default prefix for branches (e.g., "feature/"). |
| `repositories` | Map | Key: Alias, Value: `RepoDefinition { url, path }`. |

---

## 3. Global CLI Behavior
1.  **Logging:**
    * Default: `Info` level logs.
    * `--quiet` (`-q`): Suppress info, show only errors.
    * `--verbose` (`-v`): Show debug logs (file paths, git internal steps).
    * **Rule:** Use `log` macros, never `println!` for status updates.
2.  **Help:** Autogenerated help messages via `clap`.
3.  **Completions:** Ability to generate shell completions.

---

## 4. Commands & Features

### `init`
* **Goal:** Bootstrap configuration interactively.
* **Behavior:** Uses `dialoguer` to prompt the user for directories and defaults. Saves to `config.toml`.

### `add-repo <repo> [--alias <name>]`
* **Goal:** Register a repository so `tix` can manage it.
* **Input Parsing:**
    1.  **Full URL:** `git@github.com:owner/repo.git` -> infers name "repo", saves URL as-is.
    2.  **Owner/Name:** `owner/repo` -> constructs URL using `github_base_url`.
    3.  **Name Only:** `repo` -> constructs URL using `default_repository_owner`.
* **Storage:** Saves to `config.repositories` as a `RepoDefinition` containing the remote URL and the calculated local path.

### `setup <ticket> [repos...]`
* **Goal:** Bootstrap a new ticket environment.
* **Flags:**
    * `--all` (`-a`): Setup worktrees for ALL registered repositories.
    * `--description` (`-d`): Optional description string.
* **Logic:**
    1.  **Directory:** Creates `~/tickets/<ticket>`.
    2.  **Stamp:** Creates `.tix/info.toml` storing ID and timestamp.
    3.  **Branch Naming:**
        * Format: `<prefix>/<ticket>-<sanitized-description>`
        * Sanitization: Lowercase, replace spaces/symbols with hyphens, trim trailing hyphens.
    4.  **Worktree Creation:**
        * If specific repos provided: Setup those.
        * If `--all`: Setup all.
        * If none: Create empty folder + `.tix` stamp and warn user.
    5.  **Git Logic:** See "Git Operations" below.

### `destroy <ticket>`
* **Goal:** Safely remove a ticket workspace.
* **Flags:**
    * `--force` (`-f`): Skip safety checks.
* **Logic:**
    1.  **Safety Check:** Iterates all worktrees in the ticket folder. Checks if `git status` is clean. If dirty, prompt user for confirmation (unless `--force`).
    2.  **Deletion:** `fs::remove_dir_all` on the ticket directory.
    3.  **Pruning:** Calls `git worktree prune` (via library) for the specific worktree name on all managed repos to clean up metadata.

### `add <repo> [--ticket <id>] [--branch <name>]`
* **Goal:** Add a single repo worktree to an *existing* ticket workspace.
* **Inference:** If `--ticket` is missing, infer ID from current working directory (checking `.tix` stamp).

### `remove <repo> [--ticket <id>]`
* **Goal:** Remove a single repo worktree from a ticket.
* **Logic:** Check for uncommitted changes -> Delete folder -> Prune git metadata.

### `config <key> [value]`
* **Goal:** View or edit configuration values (e.g., change the `branch_prefix`).

### `setup-repos`
* **Goal:** Clone all registered repositories from `config.repositories` into `code_directory`.
* **Logic:** Checks if path exists. If not, performs `git clone`.

---

## 5. Git Operations Logic (via `git2`)

### Worktree Creation
* **Existing Branch:** If the calculated branch name already exists in the repo, **use it** (check it out).
* **New Branch:** If it does not exist, find the Base Commit (defaulting to `HEAD`, or a specified base like `main`) and create the branch.
* **Safety:** Must handle cases where the repo is bare or HEAD is detached.

### Worktree Pruning
* **Method:** Targeted removal. Do not run a global `git worktree prune`. Remove the directory first, then prune the specific metadata entry matching the worktree name.